<!DOCTYPE html>
<html th:replace="~{layout :: layout(~{::title}, ~{::section})}">
<head>
    <meta charset="UTF-8">
    <title>강의 재생</title>
</head>
<body>
<section>
    <div style="width:800px;" class="container">
        <h3 th:text="${video.name}" class="text-primary"></h3>
        <hr>
        <iframe th:if="${video.videoRoute.substring(0,5)=='https'}" width="770px" height="500px"
                id="video-player-youtube"
                th:src="${video.videoRoute}"
                title="YouTube video player"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen></iframe>

        <video th:if="${video.videoRoute.substring(0,5)!='https'}" width="770px" height="500px" id="video-player"
               th:src="|/lecture/videoFile/${video.videoRoute}|" autoplay="autoplay" controls="controls">
        </video>
        <hr>
        <a th:href="|/lecture/prev-video/${video.lecture.id}/${video.id}|" class="btn btn-info">이전 화</a>
        <a th:href="|/lecture/next-video/${video.lecture.id}/${video.id}|" class="btn btn-info">다음 화</a>
    </div>
    <script th:inline="javascript">
        // video 태그에서 id가 video-player인 요소를 가져옵니다.
        var video = document.getElementById("video-player");
        var watched = false;
        var videoId = [[${video.id}]];
        video.addEventListener("canplay", function () {
            // 총 재생시간을 가져옵니다. (초 단위)
            var duration = video.duration;

            // 현재 재생 시간을 가져옵니다. (초 단위)
            var currentTime = video.currentTime;

            function updateTime() {
                currentTime = video.currentTime;
            }

            function log() {
                if (!watched) {
                    console.log(`총 재생 시간 : ${duration}`);
                    console.log(`현재 재생 시간 : ${currentTime}`);
                    if (currentTime / duration >= 0.99) {
                        console.log("영상 시청 완료");
                        fetch(`/lecture/video/watched/` + videoId, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                        })
                        watched = true;
                    }
                }
            }

            video.addEventListener("timeupdate", updateTime)
            setInterval(log, 1000);
        });
    </script>
</section>
</body>
</html>